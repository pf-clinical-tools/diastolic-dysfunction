<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Clinical Interpretation of Diastolic Function in Suspected Heart Failure</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

<!-- TOOL_MARKER_CI_DIASTOLIC_HF_V1_0_LOCKED_FINAL_NO_NP_DERIVATION_BOX -->
<!-- TOOL_MARKER_CI_DIASTOLIC_HF_V1_1_4_OUTPUT_CLEAN_NO_SCOPE_COPY_BSE_CITATION_NO_LOGIC_DRIFT -->

<style>
  :root{
    --bg:#f4f6f8;
    --card:#ffffff;
    --text:#111827;
    --muted:#6b7280;
    --border:#e5e7eb;
    --shadow:0 8px 24px rgba(0,0,0,.08);
    --radius:14px;

    --ok:#166534;
    --warn:#b45309;
    --stop:#b91c1c;
  }

  *{ box-sizing:border-box; }

  html, body{
    margin:0;
    padding:0;
    background:var(--bg);
    color:var(--text);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
    line-height:1.45;
    -webkit-text-size-adjust:100%;
  }

  body{
    padding:12px;
    padding-bottom:calc(12px + env(safe-area-inset-bottom));
  }

  .wrap{ max-width:980px; margin:0 auto; }

  .card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:var(--radius);
    padding:14px;
    margin-top:12px;
    box-shadow:var(--shadow);
  }

  h1{ font-size:1.25rem; margin:0 0 6px 0; letter-spacing:.2px; }
  h2{ font-size:1.05rem; margin:0 0 8px 0; }
  h3{ font-size:1.0rem; margin:0 0 6px 0; }
  p{ margin:6px 0; }

  .muted{ color:var(--muted); font-size:.92rem; }
  .tiny{ font-size:.88rem; }

  .grid{ display:grid; grid-template-columns:1fr; gap:10px; }
  @media(min-width:860px){
    .grid.two{ grid-template-columns:1fr 1fr; }
    .grid.three{ grid-template-columns:1fr 1fr 1fr; }
  }

  fieldset{
    border:1px solid var(--border);
    border-radius:12px;
    padding:10px;
    margin:0;
    min-width:0;
  }
  legend{ padding:0 6px; font-weight:700; font-size:.9rem; }

  label{
    display:flex;
    align-items:center;
    gap:10px;
    font-size:.95rem;
    margin:8px 0;
    user-select:none;
    min-height:44px;
  }

  input[type="checkbox"], input[type="radio"]{ transform:scale(1.08); }

  input[type="number"]{
    width:100%;
    padding:12px;
    border-radius:10px;
    border:1px solid var(--border);
    font-size:16px;
    background:#fff;
  }

  .gate{
    padding:10px 12px;
    border-radius:12px;
    border:1px solid var(--border);
    background:#f9fafb;
    font-size:.95rem;
    margin-top:10px;
  }
  .gate.ok{
    border-color:rgba(22,101,52,.35);
    background:rgba(22,101,52,.06);
    color:var(--ok);
    font-weight:800;
  }
  .gate.warn{
    border-color:rgba(180,83,9,.35);
    background:rgba(180,83,9,.07);
    color:var(--warn);
    font-weight:800;
  }
  .gate.stop{
    border-color:rgba(185,28,28,.35);
    background:rgba(185,28,28,.07);
    color:var(--stop);
    font-weight:900;
  }

  .outbox{
    border:1px solid var(--border);
    border-radius:12px;
    padding:12px;
    background:#fff;
    margin-top:10px;
  }

  .output{
    white-space:pre-wrap;
    font-size:16px;
    line-height:1.45;
    margin:0;
    -webkit-user-select:text;
    user-select:text;
  }

  .btnrow{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    margin-top:10px;
    align-items:center;
  }

  button{
    appearance:none;
    border:1px solid var(--border);
    background:#111827;
    color:#fff;
    padding:12px 14px;
    border-radius:12px;
    cursor:pointer;
    font-weight:800;
    font-size:16px;
    min-height:44px;
  }
  button.secondary{ background:#fff; color:#111827; }
  button:disabled{ opacity:.55; cursor:not-allowed; }

  details{
    border:1px solid var(--border);
    border-radius:12px;
    padding:10px 12px;
    background:#fff;
    margin-top:12px;
  }
  summary{ cursor:pointer; font-weight:800; }

  .footer{
    margin-top:12px;
    font-size:.88rem;
    color:var(--muted);
  }

  .hint{
    color:var(--muted);
    font-size:.86rem;
    line-height:1.35;
    margin-top:6px;
  }

  .srOnly{
    position:absolute;
    width:1px;
    height:1px;
    padding:0;
    margin:-1px;
    overflow:hidden;
    clip:rect(0,0,0,0);
    white-space:nowrap;
    border:0;
  }

  /* Smaller KEY INTERPRETATION callouts */
  .callout{
    border:1px solid var(--border);
    border-radius:12px;
    padding:8px 10px;
    margin:6px 0;
    background:#fff;
  }
  .callout .title{
    font-weight:900;
    margin-bottom:3px;
    font-size:0.92rem;
  }
  .callout.ok{
    border-left:5px solid rgba(22,101,52,.85);
    background:rgba(22,101,52,.06);
  }
  .callout.warn{
    border-left:5px solid rgba(180,83,9,.85);
    background:rgba(180,83,9,.07);
  }
  .callout.stop{
    border-left:5px solid rgba(185,28,28,.85);
    background:rgba(185,28,28,.07);
  }

  .sectionHead{
    margin-top:10px;
    font-weight:900;
    font-size:0.98rem;
  }
</style>
</head>

<body>
<div class="wrap">

  <div class="card" style="background:linear-gradient(135deg,#0f766e,#064e3b); color:#ffffff;">
    <h1>Clinical Interpretation of Diastolic Function in Suspected Heart Failure</h1>
    <p class="muted" style="color:#e5e7eb; margin-top:4px;">
      v1.1.4 — NICE-first documentation framework. Emphasises dominant physiology and probabilistic attribution.
    </p>
    <p class="tiny" style="color:#e5e7eb; margin-top:6px;">
      Not a diagnostic HFpEF or diastolic grading tool; use within a wider guideline-based pathway.
    </p>
  </div>

  <!-- PURPOSE -->
  <div class="card">
    <h2>Purpose &amp; scope</h2>
    <p>
      This tool supports <strong>clinical interpretation and documentation</strong> of echocardiographic
      diastolic information and natriuretic peptides in patients with <strong>suspected heart failure</strong>,
      particularly where left ventricular ejection fraction is preserved or mildly reduced.
    </p>
    <div class="outbox">
      <p class="output">
This tool:
• Does NOT assign diastolic grade
• Does NOT replace specialist cardiology assessment
• Provides NICE-aligned probabilistic synthesis to support diagnosis and documentation
      </p>
    </div>
  </div>

  <!-- MODULE 1 -->
  <div class="card" id="module1">
    <h2>Module 1 — Clinical heart failure syndrome (required)</h2>
    <fieldset>
      <legend>Clinical assessment</legend>
      <label><input type="checkbox" id="hfSymptoms"> Symptoms and/or signs consistent with heart failure</label>
      <label><input type="checkbox" id="noAltDx"> No alternative dominant diagnosis explaining the presentation</label>
    </fieldset>

    <div class="gate warn" id="m1Gate">
      Complete both items to proceed.
      <span class="muted">(NICE: heart failure is a clinical syndrome; tests provide supportive evidence.)</span>
    </div>
  </div>

  <!-- EF GATE -->
  <div class="card" id="efGateCard">
    <h2>EF gate — scope control</h2>
    <fieldset>
      <legend>Select ONE EF category</legend>
      <label><input type="radio" name="efcat" id="ef_ge50" value="ge50"> EF ≥50% (preserved EF)</label>
      <label><input type="radio" name="efcat" id="ef_41_49" value="41_49"> EF 41–49% (mildly reduced EF)</label>
      <label><input type="radio" name="efcat" id="ef_le40" value="le40"> EF ≤40% (reduced EF / HFrEF)</label>
    </fieldset>

    <div class="gate warn" id="efGate">Select one EF category to proceed.</div>

    <div class="outbox">
      <p class="output">
This tool applies only to suspected heart failure with preserved (≥50%) or mildly reduced (41–49%) ejection fraction.
If EF ≤40%, this pathway does not apply.
      </p>
    </div>
  </div>

  <!-- MODULE 2 -->
  <div class="card" id="module2">
    <h2>Module 2 — Echocardiographic interpretability</h2>

    <div class="grid two">
      <fieldset>
        <legend>Rhythm</legend>
        <label><input type="radio" name="rhythm" id="rhythm_sinus" value="sinus" checked> Sinus rhythm / not AF</label>
        <label><input type="radio" name="rhythm" id="rhythm_af" value="af"> Atrial fibrillation</label>
        <div class="hint">
          AF note: standard diastolic algorithms require modified criteria in AF; this framework treats AF as non-interpretable for HFpEF attribution and records values for completeness only.
        </div>
      </fieldset>

      <fieldset>
        <legend>Mitral regurgitation (explicit)</legend>
        <label><input type="radio" name="mr_severity" id="mr_none" value="none" checked> None / trivial</label>
        <label><input type="radio" name="mr_severity" id="mr_mild" value="mild"> Mild</label>
        <label><input type="radio" name="mr_severity" id="mr_mod" value="moderate"> Moderate</label>
        <label><input type="radio" name="mr_severity" id="mr_sev" value="severe"> Severe</label>
        <p class="muted"><strong>Significant MR</strong> = <strong>moderate or severe</strong>.</p>
      </fieldset>
    </div>

    <div class="grid two" style="margin-top:10px;">
      <fieldset>
        <legend>Aortic stenosis severity (gate-lite)</legend>
        <label><input type="radio" name="as_severity" id="as_none" value="none" checked> None / mild</label>
        <label><input type="radio" name="as_severity" id="as_mod" value="moderate"> Moderate</label>
        <label><input type="radio" name="as_severity" id="as_sev" value="severe"> Severe</label>
        <div class="hint">
          Moderate/severe AS: treated as dominant physiology here; Doppler indices are not used to attribute symptoms to HFpEF.
        </div>
      </fieldset>

      <fieldset>
        <legend>Image / Doppler quality</legend>
        <label><input type="radio" name="dopplerQuality" id="limitedEcho_no" value="no" checked> Adequate (no major limitation)</label>
        <label><input type="radio" name="dopplerQuality" id="limitedEcho_yes" value="yes"> Limited image or Doppler quality</label>
      </fieldset>
    </div>

    <div class="grid two" style="margin-top:10px;">
      <fieldset>
        <legend>Timing / fusion</legend>
        <label><input type="radio" name="timingFusion" id="pacing_no" value="no" checked> Not present / not stated</label>
        <label><input type="radio" name="timingFusion" id="pacing_yes" value="yes"> Pacing rhythm, tachycardia, or E–A fusion</label>
      </fieldset>

      <fieldset>
        <legend>Scope reminder</legend>
        <p class="output">This framework does not assign diastolic grade or filling pressure; it provides documentation-supportive synthesis using EF, structural context and natriuretic peptides.</p>
      </fieldset>
    </div>

    <div class="gate warn" id="m2Gate">
      Formal diastolic grading is not assigned when rhythm/valvular/technical limitations are present.
      The tool continues using EF + structural context + natriuretic peptides (NICE-aligned).
    </div>

    <div class="outbox">
      <h3>Interpretability statement (copy-ready)</h3>
      <p class="output" id="m2Text">
Formal diastolic grading is not assigned in this context. The tool continues using EF, structural echocardiographic context and natriuretic peptides (NICE-aligned).
      </p>
    </div>
  </div>

  <!-- MODULE 3 -->
  <div class="card" id="module3">
    <h2>Module 3 — Structural echocardiographic features (supportive)</h2>

    <div class="grid two">
      <fieldset>
        <legend>Left atrial size</legend>
        <label style="display:block; min-height:auto; user-select:auto;">
          Left atrial volume index (LAVI, ml/m²)
          <input type="number" id="lavi" inputmode="decimal" step="0.1" placeholder="e.g. 42">
        </label>
        <p class="muted">Reference: normal ≤34 ml/m².</p>
        <label><input type="checkbox" id="laQual"> LA enlargement reported qualitatively (no LAVI provided)</label>
      </fieldset>

      <fieldset>
        <legend>LV wall thickness</legend>
        <label style="display:block; min-height:auto; user-select:auto;">
          Septal thickness (mm)
          <input type="number" id="ivs" inputmode="decimal" step="0.1" placeholder="e.g. 12">
        </label>
        <label style="display:block; min-height:auto; user-select:auto;">
          Posterior wall thickness (mm)
          <input type="number" id="pwd" inputmode="decimal" step="0.1" placeholder="e.g. 11">
        </label>
        <p class="muted">Reference: normal ≤10 mm; ≥11 mm supports LV wall thickening.</p>
      </fieldset>
    </div>

    <div class="grid two" style="margin-top:10px;">
      <fieldset>
        <legend>Pulmonary pressures (optional)</legend>
        <label style="display:block; min-height:auto; user-select:auto;">
          TR Vmax (m/s)
          <input type="number" id="trvmax" inputmode="decimal" step="0.01" placeholder="e.g. 3.1">
        </label>
        <p class="muted">Supportive threshold: TR Vmax &gt;2.8 m/s.</p>
        <label style="display:block; min-height:auto; user-select:auto;">
          PASP (mmHg)
          <input type="number" id="pasp" inputmode="decimal" step="1" placeholder="e.g. 42">
        </label>
        <p class="muted">Supportive threshold: PASP &gt;35 mmHg.</p>
      </fieldset>

      <fieldset>
        <legend>Safety principle</legend>
        <p class="output">Normal resting echocardiographic surrogates do not exclude exertional or load-dependent HFpEF.</p>
        <p class="muted">HFpEF may be exertional or load/heart-rate dependent; resting echo can be neutral.</p>
      </fieldset>
    </div>

    <div class="outbox">
      <h3>Auto-generated echo interpretation snippets</h3>
      <p class="output" id="echoSnips">Enter available echocardiographic values above to generate supportive statements.</p>
    </div>
  </div>

  <!-- MODULE 4 -->
  <div class="card" id="module4">
    <h2>Module 4 — Natriuretic peptides (NICE-prioritised)</h2>

    <div class="grid two">
      <fieldset>
        <legend>Measured values (numbers only)</legend>
        <label style="display:block; min-height:auto; user-select:auto;">
          BNP (pg/mL)
          <input type="number" id="bnp" inputmode="decimal" step="1" placeholder="e.g. 180">
        </label>
        <label style="display:block; min-height:auto; user-select:auto;">
          NT-proBNP (pg/mL)
          <input type="number" id="ntprobnp" inputmode="decimal" step="1" placeholder="e.g. 1600">
        </label>
        <label><input type="checkbox" id="np_af"> AF present (NP interpretation context)</label>
        <label><input type="checkbox" id="np_ckd"> CKD present (NP interpretation context)</label>
        <p class="muted">
          NICE thresholds used: NT-proBNP &lt;400 low; 400–2000 intermediate; ≥2000 high. BNP &lt;100 low; 100–400 intermediate; &gt;400 high.
        </p>
      </fieldset>

      <fieldset>
        <legend>Notes</legend>
        <p class="muted">
          If neither BNP nor NT-proBNP is available, NP tier is “unknown” and the tool will not output “supportive HFpEF” language or SGLT2 text.
        </p>
        <p class="muted">
          Safety: low NP reduces HF probability; echocardiographic indices should not override low NP within this framework.
        </p>
      </fieldset>
    </div>

    <div class="outbox">
      <h3>Auto-generated natriuretic peptide interpretation</h3>
      <p class="output" id="npSnip">Enter BNP and/or NT-proBNP to generate NP interpretation.</p>
    </div>
  </div>

  <!-- MODULE 5 -->
  <div class="card" id="module5">
    <h2>Module 5 — Output</h2>
    <p class="muted">
      This output is generated automatically from Modules 1–4. It supports documentation only and must be reviewed by the clinician.
      It does not constitute a diagnosis or a treatment directive.
    </p>

    <div class="outbox">
      <h3>Output text</h3>

      <!-- Copy-only block -->
      <div id="copyBlock" class="output">Complete Modules 1–4 to generate output.</div>

      <!-- Treatment shown separately (not copied) -->
      <div id="treatBlock" class="output" style="margin-top:10px;"></div>

      <textarea id="fallbackArea" class="srOnly" aria-hidden="true"></textarea>

      <div class="btnrow">
        <button id="copyBtn" disabled>Copy interpretive text</button>
        <button id="resetBtn" class="secondary" type="button">Reset</button>
        <span class="muted" id="toast" style="display:none; font-weight:900; color:var(--ok);">Copied ✓</span>
      </div>
    </div>
  </div>

  <!-- GOVERNANCE DISCLAIMER -->
  <details id="disclaimer">
    <summary>Disclaimer &amp; governance statement</summary>
    <div class="footer">
      <p><strong>Disclaimer:</strong> This tool is intended to support <strong>clinical reasoning and documentation</strong> in patients with suspected heart failure.</p>
      <p>It does <strong>not</strong> replace specialist cardiology input and does <strong>not</strong> mandate treatment.</p>
      <p>Clinical judgement, patient-specific factors, comorbidities, and local guidance must always be applied.</p>
    </div>
  </details>

  <!-- REFERENCES -->
  <details id="refs">
    <summary>References (compact)</summary>
    <div class="footer">
      <ol style="margin:10px 0 0 18px; padding:0;">
        <li>NICE. <i>Chronic heart failure in adults: diagnosis and management (NG106)</i>. 2018.</li>
        <li>Robinson S, Ring L, Oxborough D, et al. The assessment of left ventricular diastolic function: guidance and recommendations from the British Society of Echocardiography. <i>Echo Res Pract</i>. 2024;11:16. doi:10.1186/s44156-024-00051-2.</li>
        <li>McDonagh TA, et al. 2021 ESC Guidelines for the diagnosis and treatment of acute and chronic heart failure. <i>Eur Heart J</i>. 2021.</li>
        <li>Bozkurt B, et al. Universal definition and classification of heart failure. <i>J Card Fail</i>. 2021.</li>
        <li>Obokata M, et al. Role of diastolic stress testing in HFpEF. <i>Circulation</i>. 2017.</li>
        <li>Nagueh SF, et al. Evaluation of LV diastolic function by echocardiography. <i>J Am Soc Echocardiogr</i>. 2016.</li>
        <li>Anker SD, et al. EMPEROR-Preserved. <i>N Engl J Med</i>. 2021.</li>
        <li>Solomon SD, et al. DELIVER. <i>N Engl J Med</i>. 2022.</li>
        <li>Otto CM, et al. 2020 ACC/AHA Guideline for the Management of Patients With Valvular Heart Disease. <i>Circulation</i>. 2021.</li>
      </ol>
    </div>
  </details>

  <div class="footer" id="copyright">
    © 2026 <strong>Prabhath Fernando MBBS MD FRCP</strong>. <strong>All rights reserved.</strong><br>
    This tool and its underlying clinical logic may not be reproduced, modified, or redistributed without permission.
  </div>

</div><!-- /wrap -->

<script>
(function(){
  const el = (id)=>document.getElementById(id);
  const num = (v)=> (v===null || v==='' || Number.isNaN(Number(v))) ? null : Number(v);
  const has = (v)=> v!==null;

  function isAF(){ return el('rhythm_af').checked; }

  function efCategory(){
    if (el('ef_ge50').checked) return 'ge50';
    if (el('ef_41_49').checked) return '41_49';
    if (el('ef_le40').checked) return 'le40';
    return '';
  }

  function mrSeverity(){
    if (el('mr_sev').checked) return 'severe';
    if (el('mr_mod').checked) return 'moderate';
    if (el('mr_mild').checked) return 'mild';
    if (el('mr_none').checked) return 'none';
    return '';
  }

  function asSeverity(){
    if (el('as_sev').checked) return 'severe';
    if (el('as_mod').checked) return 'moderate';
    return 'none';
  }

  function setCardEnabled(id, enabled){
    const c = el(id);
    c.style.opacity = enabled ? '1' : '.55';
    c.style.pointerEvents = enabled ? 'auto' : 'none';
  }

  function updateM1(){
    const ok = el('hfSymptoms').checked && el('noAltDx').checked;
    const gate = el('m1Gate');
    if (!ok){
      gate.className = 'gate warn';
      gate.innerHTML = 'Complete both items to proceed. <span class="muted">(NICE: HF is a clinical syndrome.)</span>';
      setCardEnabled('efGateCard', false);
      ['module2','module3','module4','module5'].forEach(id=>setCardEnabled(id,false));
      el('copyBlock').textContent = 'Complete Module 1 and EF gate to generate output.';
      el('treatBlock').textContent = '';
      el('copyBtn').disabled = true;
      return false;
    }
    gate.className = 'gate ok';
    gate.textContent = 'Gate passed. Proceed to EF scope control.';
    setCardEnabled('efGateCard', true);
    return true;
  }

  function updateEF(){
    const cat = efCategory();
    const gate = el('efGate');

    if (!cat){
      gate.className = 'gate warn';
      gate.textContent = 'Select one EF category to proceed.';
      ['module2','module3','module4','module5'].forEach(id=>setCardEnabled(id,false));
      el('copyBtn').disabled = true;
      el('copyBlock').textContent = 'Select an EF category to generate output.';
      el('treatBlock').textContent = '';
      return false;
    }

    if (cat === 'le40'){
      gate.className = 'gate stop';
      gate.innerHTML = '<strong>Stop:</strong> EF ≤40% is consistent with HFrEF. This tool applies only to preserved (≥50%) or mildly reduced (41–49%) EF.';
      ['module2','module3','module4','module5'].forEach(id=>setCardEnabled(id,false));
      el('copyBlock').textContent = 'EF ≤40% selected. This pathway does not apply (HFrEF).';
      el('treatBlock').textContent = '';
      el('copyBtn').disabled = true;
      return false;
    }

    gate.className = 'gate ok';
    gate.textContent = (cat==='ge50') ? 'EF gate passed: preserved EF.' : 'EF gate passed: mildly reduced EF.';
    ['module2','module3','module4','module5'].forEach(id=>setCardEnabled(id,true));
    return true;
  }

  function updateM2(){
    const limited = el('limitedEcho_yes').checked;
    const pacing = el('pacing_yes').checked;
    const mr = mrSeverity();
    const as = asSeverity();
    const significantMR = (mr==='moderate' || mr==='severe');
    const significantAS = (as==='moderate' || as==='severe');

    const gate = el('m2Gate');
    const text = el('m2Text');

    const reasons=[];
    if (isAF()) reasons.push('atrial fibrillation');
    if (significantMR) reasons.push('significant mitral regurgitation');
    if (significantAS) reasons.push('moderate/severe aortic stenosis (dominant valve physiology)');
    if (limited) reasons.push('limited image/Doppler quality');
    if (pacing) reasons.push('pacing/tachycardia/E–A fusion');

    if (reasons.length){
      gate.className = 'gate warn';
      gate.innerHTML =
        '<strong>Interpretability:</strong> Formal diastolic grading is not assigned due to ' + reasons.join(', ') + '. ' +
        'The tool continues using EF + structural context + natriuretic peptides (NICE-aligned).';
      text.textContent =
        'Formal diastolic grading is not assigned in this context. The tool continues using EF, structural echocardiographic context and natriuretic peptides (NICE-aligned).';
    } else {
      gate.className = 'gate ok';
      gate.textContent =
        'No major rhythm/valvular/technical limitation selected. (This framework still does not assign a diastolic grade; it provides supportive synthesis.)';
      text.textContent =
        'Formal diastolic grading is not assigned within this framework; echocardiographic parameters are interpreted as supportive context alongside natriuretic peptides and clinical findings.';
    }
  }

  function updateEchoSnips(){
    const snips=[];
    const mr = mrSeverity();
    const as = asSeverity();
    const significantMR = (mr==='moderate' || mr==='severe');
    const significantAS = (as==='moderate' || as==='severe');

    const valveNote =
      significantMR && significantAS ? ' (interpret cautiously in significant MR and moderate/severe AS).' :
      significantMR ? ' (non-specific in significant MR).' :
      significantAS ? ' (may reflect pressure overload in moderate/severe AS).' :
      '.';

    const lavi = num(el('lavi').value);
    const laQual = el('laQual').checked;

    if (has(lavi)){
      if (lavi>34){
        snips.push(`Left atrial volume index is ${lavi.toFixed(1)} ml/m² (normal ≤34). Left atrial enlargement supports chronic atrial/diastolic burden${valveNote}`);
      } else {
        snips.push(`Left atrial volume index is ${lavi.toFixed(1)} ml/m² (normal ≤34). Normal LA size does not exclude HFpEF.`);
      }
    } else if (laQual){
      snips.push(`Left atrial enlargement reported qualitatively (LAVI not provided). Left atrial enlargement supports chronic atrial/diastolic burden${valveNote}`);
    }

    const ivs = num(el('ivs').value);
    const pwd = num(el('pwd').value);
    if (has(ivs) || has(pwd)){
      const thick = (has(ivs)&&ivs>=11) || (has(pwd)&&pwd>=11);
      const parts=[];
      if (has(ivs)) parts.push(`septal ${ivs.toFixed(1)} mm`);
      if (has(pwd)) parts.push(`posterior ${pwd.toFixed(1)} mm`);
      if (thick){
        snips.push(`LV wall thickness (${parts.join(', ')}) indicates LV wall thickening, supporting a pressure-loading phenotype consistent with HFpEF.`);
      } else {
        snips.push(`LV wall thickness (${parts.join(', ')}) is within normal limits; absence of LVH does not exclude HFpEF.`);
      }
    }

    const tr = num(el('trvmax').value);
    const pasp = num(el('pasp').value);
    if (has(tr)){
      if (tr>2.8){
        snips.push(`TR Vmax ${tr.toFixed(2)} m/s (>2.8) supports elevated pulmonary pressures in context${valveNote}`);
      } else {
        snips.push(`TR Vmax ${tr.toFixed(2)} m/s (≤2.8). Normal TR velocity does not exclude HFpEF.`);
      }
    } else if (has(pasp)){
      if (pasp>35){
        snips.push(`Estimated PASP ${Math.round(pasp)} mmHg (>35) supports elevated pulmonary pressures in context${valveNote}`);
      } else {
        snips.push(`Estimated PASP ${Math.round(pasp)} mmHg (≤35). Normal PASP does not exclude HFpEF.`);
      }
    }

    el('echoSnips').textContent = snips.length ? snips.join('\n\n')
      : 'Enter available echocardiographic values above to generate supportive statements.';
  }

  function npTier(){
    const nt = num(el('ntprobnp').value);
    if (has(nt)){
      if (nt < 400) return 'low';
      if (nt >= 2000) return 'high';
      return 'mid';
    }
    const bnp = num(el('bnp').value);
    if (has(bnp)){
      if (bnp < 100) return 'low';
      if (bnp > 400) return 'high';
      return 'mid';
    }
    return '';
  }

  function updateNPSnip(){
    const tier = npTier();
    const ctx=[];
    if (el('np_af').checked) ctx.push('AF');
    if (el('np_ckd').checked) ctx.push('CKD');
    const ctxStr = ctx.length ? ` Context: ${ctx.join(', ')}.` : '';

    const bnp = num(el('bnp').value);
    const nt = num(el('ntprobnp').value);
    let vals='';
    if (has(bnp)) vals += `BNP ${Math.round(bnp)} pg/mL. `;
    if (has(nt)) vals += `NT-proBNP ${Math.round(nt)} pg/mL. `;

    if (!tier){
      el('npSnip').textContent = 'Enter BNP and/or NT-proBNP to generate NP interpretation.';
      return;
    }

    if (tier === 'low'){
      el('npSnip').textContent = `${vals}Natriuretic peptide interpretation: low (HF less likely; NICE thresholds).${ctxStr}`;
    } else if (tier === 'mid'){
      el('npSnip').textContent = `${vals}Natriuretic peptide interpretation: intermediate/indeterminate (NICE thresholds).${ctxStr}`;
    } else {
      el('npSnip').textContent = `${vals}Natriuretic peptide interpretation: high/elevated (NICE thresholds).${ctxStr} Natriuretic peptides provide objective evidence of myocardial stress when interpreted with imaging and clinical context.`;
    }
  }

  function calloutHTML(level, title, body){
    return `
      <div class="callout ${level}">
        <div class="title">${title}</div>
        <div>${body}</div>
      </div>
    `;
  }

  function buildFinal(){
    if (!(updateM1() && updateEF())) return;

    updateM2();
    updateEchoSnips();
    updateNPSnip();

    const mr = mrSeverity();
    const as = asSeverity();
    const significantMR = (mr==='moderate' || mr==='severe');
    const significantAS = (as==='moderate' || as==='severe');

    const limited = el('limitedEcho_yes').checked;
    const pacing = el('pacing_yes').checked;

    const limitations=[];
    if (isAF()) limitations.push('atrial fibrillation');
    if (significantMR) limitations.push('significant mitral regurgitation');
    if (significantAS) limitations.push('moderate/severe aortic stenosis');
    if (limited) limitations.push('limited image/Doppler quality');
    if (pacing) limitations.push('pacing/tachycardia/E–A fusion');

    const echoText = el('echoSnips').textContent.startsWith('Enter') ? '' : el('echoSnips').textContent;
    const npText = el('npSnip').textContent.startsWith('Enter') ? '' : el('npSnip').textContent;

    const lavi = num(el('lavi').value);
    const laSupport = (has(lavi) && lavi > 34) || el('laQual').checked;
    const ivs = num(el('ivs').value);
    const pwd = num(el('pwd').value);
    const lvhSupport = (has(ivs) && ivs >= 11) || (has(pwd) && pwd >= 11);
    const tr = num(el('trvmax').value);
    const pasp = num(el('pasp').value);
    const pulmSupport = (has(tr) && tr > 2.8) || (has(pasp) && pasp > 35);
    const structuralSupport = laSupport || lvhSupport || pulmSupport;

    const tier = npTier();
    const npLowFlag = (tier === 'low');
    const npHighFlag = (tier === 'high');
    const npKnown = (tier !== '');

    let hfpEfStatus = 'indeterminate';
    if (!npKnown) hfpEfStatus = 'indeterminate';
    else if (npLowFlag) hfpEfStatus = 'not_supportive';
    else if (structuralSupport) hfpEfStatus = 'supportive';
    else hfpEfStatus = 'indeterminate';

    if (significantAS) hfpEfStatus = 'indeterminate'; // AS-dominant safeguard (unchanged logic)

    const interpretive = [];
    const treatment = [];

    interpretive.push(`<div class="sectionHead">INTERPRETIVE DOCUMENTATION</div>`);

    if (significantMR){
      interpretive.push(`<div>${[
        'The patient has clinical features consistent with a heart failure syndrome with preserved or mildly reduced ejection fraction.',
        'Formal diastolic grading is not assigned due to significant mitral regurgitation.',
        'In this context, left atrial enlargement, pulmonary pressure surrogates, and raised natriuretic peptides may reflect valvular volume overload and atrial stretch rather than primary myocardial diastolic dysfunction.'
      ].join(' ')}</div>`);

      if (echoText) interpretive.push(`<div><b>Echocardiographic context:</b> ${echoText.replace(/\n+/g,' ').trim()}</div>`);
      if (npText) interpretive.push(`<div><b>Natriuretic peptide context:</b> ${npText.replace(/\n+/g,' ').trim()}</div>`);

      interpretive.push(calloutHTML(
        'stop',
        'KEY INTERPRETATION (MR-dominant physiology)',
        'Therefore, echocardiography and natriuretic peptides in this setting cannot be used to support or refute a HFpEF phenotype, and attribution to HFpEF remains indeterminate.'
      ));

      interpretive.push(`<div>Management decisions should prioritise assessment of the haemodynamic significance of mitral regurgitation, recognising that co-existing HFpEF cannot be excluded but cannot be reliably inferred from resting diastolic surrogates in significant MR.</div>`);

      treatment.push(`<div class="sectionHead">TREATMENT GUIDANCE (CONTEXT-DEPENDENT, NON-DIRECTIVE)</div>`);
      treatment.push(`<ul>
        <li>In significant mitral regurgitation, HFpEF-specific therapy should not be inferred from resting diastolic surrogates alone; management should be guided by dominant valvular physiology and the overall clinical syndrome.</li>
        <li>If congested, symptomatic treatment (including diuretics) should be guided by clinical volume status and response, with monitoring of renal function and electrolytes.</li>
      </ul>`);

    } else if (significantAS){
      interpretive.push(`<div>${[
        'The patient has clinical features consistent with a heart failure syndrome with preserved or mildly reduced ejection fraction.',
        'Moderate/severe aortic stenosis is present and is treated here as dominant valve physiology.',
        'In this context, natriuretic peptide elevation, left atrial enlargement and pulmonary pressure surrogates may reflect pressure overload from aortic stenosis rather than primary myocardial diastolic dysfunction.'
      ].join(' ')}</div>`);

      if (echoText) interpretive.push(`<div><b>Echocardiographic context:</b> ${echoText.replace(/\n+/g,' ').trim()}</div>`);
      if (npText) interpretive.push(`<div><b>Natriuretic peptide context:</b> ${npText.replace(/\n+/g,' ').trim()}</div>`);

      interpretive.push(calloutHTML(
        'stop',
        'KEY INTERPRETATION (AS-dominant physiology)',
        'Therefore, echocardiography and natriuretic peptides in this setting cannot be used to support or refute a primary HFpEF phenotype, and attribution to HFpEF remains indeterminate.'
      ));

      interpretive.push(`<div>Management decisions should prioritise assessment of the haemodynamic significance of aortic stenosis, recognising that co-existing HFpEF cannot be excluded but should not be inferred automatically from resting surrogates in dominant valve disease.</div>`);

      treatment.push(`<div class="sectionHead">TREATMENT GUIDANCE (CONTEXT-DEPENDENT, NON-DIRECTIVE)</div>`);
      treatment.push(`<ul>
        <li>In moderate/severe aortic stenosis, HFpEF-directed therapy should not be inferred automatically from resting diastolic surrogates; management should be guided by dominant valve physiology and the overall clinical syndrome.</li>
        <li>If congested, symptomatic treatment (including diuretics) should be guided by clinical volume status and response, with monitoring of renal function and electrolytes.</li>
      </ul>`);

    } else {
      const para = [];
      para.push('The patient has clinical features consistent with a heart failure syndrome with preserved or mildly reduced ejection fraction.');

      if (limitations.length){
        para.push('Formal diastolic grading is not assigned due to ' + limitations.join(', ') + '.');
      } else {
        para.push('Formal diastolic grading is not assigned within this framework; echocardiographic parameters are interpreted as supportive context.');
      }

      if (echoText){
        para.push('Echocardiography demonstrates structural findings as follows: ' + echoText.replace(/\n+/g,' ').trim());
      } else {
        para.push('Echocardiography is used to exclude alternative dominant pathology and provide supportive structural context; normal resting findings do not exclude exertional or load-dependent HFpEF.');
      }

      if (npText){
        para.push(npText.replace(/\n+/g,' ').trim());
      } else {
        para.push('Natriuretic peptides should be interpreted alongside symptoms and echocardiographic findings.');
      }

      interpretive.push(`<div>${para.join(' ')}</div>`);

      if (!npKnown){
        interpretive.push(calloutHTML(
          'warn',
          'KEY INTERPRETATION (NP unavailable)',
          'Natriuretic peptide values are not available in this record; HFpEF probability remains indeterminate and should be reassessed when biomarkers are available. This framework will not output “supportive HFpEF” language or SGLT2 therapy text without measured NP values.'
        ));
      } else if (hfpEfStatus === 'not_supportive'){
        interpretive.push(calloutHTML(
          'warn',
          'KEY INTERPRETATION (Low NP cap)',
          'Natriuretic peptide levels are low, which reduces the probability of heart failure in this clinical context. Within this framework, echocardiographic surrogates should not override a low natriuretic peptide tier; alternative explanations should be considered, with clinical reassessment if the presentation evolves.'
        ));
      } else if (hfpEfStatus === 'indeterminate'){
        interpretive.push(calloutHTML(
          'warn',
          'KEY INTERPRETATION (Indeterminate HFpEF attribution)',
          'Echocardiography is structurally neutral and does not provide supportive structural evidence of HFpEF. In the setting of natriuretic peptide values that are not low, discordance between biomarkers and resting structural findings means HFpEF probability remains indeterminate; consider alternative explanations and reassess if the presentation evolves.'
        ));
      } else {
        interpretive.push(calloutHTML(
          'ok',
          'KEY INTERPRETATION (Supportive HFpEF phenotype)',
          'Taken together, the overall picture may be supportive of a HFpEF phenotype in this clinical context. This remains probabilistic and should be interpreted alongside symptoms, comorbidity burden and response to treatment, with planned reassessment.'
        ));
      }

      treatment.push(`<div class="sectionHead">TREATMENT GUIDANCE (CONTEXT-DEPENDENT, NON-DIRECTIVE)</div>`);

      const efCat = efCategory();

      if ((efCat === 'ge50' || efCat === '41_49') && npKnown && npHighFlag && structuralSupport && !significantAS){
        treatment.push(`<ul><li>Consideration of SGLT2 inhibitor therapy is supported by evidence in heart failure populations with preserved or mildly reduced ejection fraction, independent of formal diastolic grading; initiate with appropriate renal function review and monitoring.</li></ul>`);
      }

      const other = [];
      if (isAF()){
        other.push('Atrial fibrillation is a recognised HFpEF-associated phenotype; optimisation of AF management (rate/rhythm strategy as clinically appropriate) and comorbidity control forms part of holistic care.');
      }
      other.push('Diuretic therapy, where required, should be guided by clinical congestion and response rather than diastolic indices alone, with monitoring of renal function and electrolytes.');

      treatment.push(`<ul>${other.map(x=>`<li>${x}</li>`).join('')}</ul>`);
    }

    el('copyBlock').innerHTML = interpretive.join('\n');
    el('treatBlock').innerHTML = treatment.join('\n');
    el('copyBtn').disabled = false;
  }

  async function copyTextToClipboard(text){
    try{
      await navigator.clipboard.writeText(text);
      return true;
    }catch(e){}

    try{
      const ta = el('fallbackArea');
      ta.className = '';
      ta.value = text;
      ta.style.position='fixed';
      ta.style.left='-9999px';
      ta.style.top='0';
      ta.setAttribute('readonly','');
      document.body.appendChild(ta);
      ta.focus();
      ta.select();
      const ok = document.execCommand('copy');
      ta.blur();
      ta.className='srOnly';
      return !!ok;
    }catch(e){
      return false;
    }
  }

  el('copyBtn').addEventListener('click', async ()=>{
    const textToCopy = el('copyBlock').innerText;
    const ok = await copyTextToClipboard(textToCopy);
    if (ok){
      el('toast').style.display='inline';
      setTimeout(()=>el('toast').style.display='none',1200);
    } else {
      alert('Copy not available. Please select and copy manually.');
    }
  });

  el('resetBtn').addEventListener('click', ()=>{
    document.querySelectorAll('input').forEach(i=>{
      if (i.type==='checkbox') i.checked=false;
      if (i.type==='radio') i.checked=false;
      if (i.type==='number') i.value='';
    });

    el('mr_none').checked = true;
    el('as_none').checked = true;
    el('rhythm_sinus').checked = true;
    el('limitedEcho_no').checked = true;
    el('pacing_no').checked = true;

    el('echoSnips').textContent = 'Enter available echocardiographic values above to generate supportive statements.';
    el('npSnip').textContent = 'Enter BNP and/or NT-proBNP to generate NP interpretation.';
    el('copyBlock').textContent = 'Complete Modules 1–4 to generate output.';
    el('treatBlock').textContent = '';
    el('copyBtn').disabled = true;

    updateM1();
    window.scrollTo({top:0,behavior:'smooth'});
  });

  document.querySelectorAll('input').forEach(i=>{
    i.addEventListener('change', buildFinal);
    i.addEventListener('input', buildFinal);
  });

  el('mr_none').checked = true;
  el('as_none').checked = true;
  el('rhythm_sinus').checked = true;
  el('limitedEcho_no').checked = true;
  el('pacing_no').checked = true;

  updateM1();
})();
</script>

</body>
</html>
