<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Clinical Interpretation of Diastolic Function in Suspected Heart Failure</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

<!-- TOOL_MARKER_CI_DIASTOLIC_HF_V1_2_2_LOCKED_OPTION_C_DOPPLER_SUPPORT_TIGHTEN_DOPPLER_WORDING_2026_03_01 -->
<!-- CHANGELOG (v1.2.2):
     - Tightened Doppler wording: plain-English supportive when interpretable; explicit non-use when non-interpretable with reason.
     - No logic change.
     - Module 1 wording/meaning updated: “HF physiology is a likely/significant contributor…” (gate behaviour unchanged: both ticks required).
     - Module 3: retains structural inputs (LAVI/LAE, IVS/PWT, TR Vmax, PASP); explicitly excludes LA area and excludes RAE.
     - Added OPTIONAL Doppler fields (septal/lateral e′, E/e′, E/A, DT):
         * Always recorded for documentation.
         * Counts as “Doppler supportive context” ONLY if Doppler is interpretable (no AF, no significant MR, no mod/sev AS, no limited Doppler, no pacing/fusion).
         * Never assigns diastolic grade; never creates “supportive HFpEF” alone; never overrides NP-low cap or valve-dominant safeguards.
     - Output modulation: within existing headline outcome states, wording strengthened if Doppler supportive context present and interpretable.
     - Numeric input guards: non-physiological (<=0) ignored; implausible values ignored and flagged.
     - Output formatting: removed literal \n artefacts; consistent newline handling.
     - Removed redundant Doppler attribution sentence (avoids repetition when AF/non-interpretable).
     - BNP high threshold: >=400 (aligns with governance text).
     - AF context remains single source of truth from Module 2 (no duplicate AF checkbox in NP module).
-->

<style>
  :root{
    --bg:#f4f6f8;
    --card:#ffffff;
    --text:#111827;
    --muted:#6b7280;
    --border:#e5e7eb;
    --shadow:0 8px 24px rgba(0,0,0,.08);
    --radius:14px;

    --ok:#166534;
    --warn:#b45309;
    --stop:#b91c1c;
  }

  *{ box-sizing:border-box; }

  html, body{
    margin:0;
    padding:0;
    background:var(--bg);
    color:var(--text);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
    line-height:1.45;
    -webkit-text-size-adjust:100%;
  }

  body{
    padding:12px;
    padding-bottom:calc(12px + env(safe-area-inset-bottom));
  }

  .wrap{ max-width:980px; margin:0 auto; }

  .card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:var(--radius);
    padding:14px;
    margin-top:12px;
    box-shadow:var(--shadow);
  }

  h1{ font-size:1.25rem; margin:0 0 6px 0; letter-spacing:.2px; }
  h2{ font-size:1.05rem; margin:0 0 8px 0; }
  h3{ font-size:1.0rem; margin:0 0 6px 0; }
  p{ margin:6px 0; }

  .muted{ color:var(--muted); font-size:.92rem; }
  .tiny{ font-size:.88rem; }

  .grid{ display:grid; grid-template-columns:1fr; gap:10px; }
  @media(min-width:860px){
    .grid.two{ grid-template-columns:1fr 1fr; }
    .grid.three{ grid-template-columns:1fr 1fr 1fr; }
  }

  fieldset{
    border:1px solid var(--border);
    border-radius:12px;
    padding:10px;
    margin:0;
    min-width:0;
  }
  legend{ padding:0 6px; font-weight:700; font-size:.9rem; }

  label{
    display:flex;
    align-items:center;
    gap:10px;
    font-size:.95rem;
    margin:8px 0;
    user-select:none;
    min-height:44px;
  }

  input[type="checkbox"], input[type="radio"]{ transform:scale(1.08); }

  input[type="number"]{
    width:100%;
    padding:12px;
    border-radius:10px;
    border:1px solid var(--border);
    font-size:16px; /* prevents iOS zoom */
    background:#fff;
  }

  .gate{
    padding:10px 12px;
    border-radius:12px;
    border:1px solid var(--border);
    background:#f9fafb;
    font-size:.95rem;
    margin-top:10px;
  }
  .gate.ok{
    border-color:rgba(22,101,52,.35);
    background:rgba(22,101,52,.06);
    color:var(--ok);
    font-weight:800;
  }
  .gate.warn{
    border-color:rgba(180,83,9,.35);
    background:rgba(180,83,9,.07);
    color:var(--warn);
    font-weight:800;
  }
  .gate.stop{
    border-color:rgba(185,28,28,.35);
    background:rgba(185,28,28,.07);
    color:var(--stop);
    font-weight:900;
  }

  .outbox{
    border:1px solid var(--border);
    border-radius:12px;
    padding:12px;
    background:#fff;
    margin-top:10px;
  }

  .output{
    white-space:pre-wrap;
    font-size:16px;
    line-height:1.45;
    margin:0;
    -webkit-user-select:text;
    user-select:text;
  }

  .btnrow{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    margin-top:10px;
    align-items:center;
  }

  button{
    appearance:none;
    border:1px solid var(--border);
    background:#111827;
    color:#fff;
    padding:12px 14px;
    border-radius:12px;
    cursor:pointer;
    font-weight:800;
    font-size:16px;
    min-height:44px;
  }
  button.secondary{ background:#fff; color:#111827; }
  button:disabled{ opacity:.55; cursor:not-allowed; }

  details{
    border:1px solid var(--border);
    border-radius:12px;
    padding:10px 12px;
    background:#fff;
    margin-top:12px;
  }
  summary{ cursor:pointer; font-weight:800; }

  .footer{
    margin-top:12px;
    font-size:.88rem;
    color:var(--muted);
  }

  .hint{
    color:var(--muted);
    font-size:.86rem;
    line-height:1.35;
    margin-top:6px;
  }

  .srOnly{
    position:absolute;
    width:1px;
    height:1px;
    padding:0;
    margin:-1px;
    overflow:hidden;
    clip:rect(0,0,0,0);
    white-space:nowrap;
    border:0;
  }

  /* --- KEY INTERPRETATION callouts --- */
  .callout{
    border:1px solid var(--border);
    border-radius:10px;
    padding:6px 8px;
    margin:4px 0;
    background:#fff;
  }
  .callout .title{
    font-weight:900;
    margin-bottom:2px;
    font-size:0.86rem;
    line-height:1.2;
  }
  .callout.ok{
    border-left:4px solid rgba(22,101,52,.85);
    background:rgba(22,101,52,.06);
  }
  .callout.warn{
    border-left:4px solid rgba(180,83,9,.85);
    background:rgba(180,83,9,.07);
  }
  .callout.stop{
    border-left:4px solid rgba(185,28,28,.85);
    background:rgba(185,28,28,.07);
  }

  .sectionHead{
    margin-top:10px;
    font-weight:900;
    font-size:0.98rem;
  }

  .warnList{
    margin-top:8px;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid rgba(180,83,9,.35);
    background:rgba(180,83,9,.07);
    color:var(--warn);
    font-weight:800;
    font-size:.92rem;
  }
</style>
</head>

<body>
<div class="wrap">

  <!-- HEADER -->
  <div class="card" style="background:linear-gradient(135deg,#0f766e,#064e3b); color:#ffffff;">
    <h1>Clinical Interpretation of Diastolic Function in Suspected Heart Failure</h1>

    <p class="muted" style="color:#e5e7eb; margin-top:6px;">
      Decision-justification framework for Acute Medicine, Geriatrics &amp; General Internal Medicine.
      Integrates natriuretic peptides with echocardiographic context to support probabilistic diagnosis
      and documentation, without assigning diastolic grade or definitive diagnostic labels.
    </p>

    <p class="tiny" style="color:#e5e7eb; margin-top:6px;">
      Not a diagnostic HFpEF or diastolic grading tool; use within a wider guideline-based pathway.
    </p>
  </div>

  <!-- PURPOSE -->
  <div class="card">
    <h2>Purpose &amp; scope</h2>
    <p>
      This tool supports <strong>clinical interpretation and documentation</strong> of echocardiographic
      diastolic information and natriuretic peptides in patients with <strong>suspected heart failure</strong>,
      particularly where left ventricular ejection fraction is preserved or mildly reduced.
    </p>
    <div class="outbox">
      <p class="output">
This tool:
• Does NOT assign diastolic grade
• Does NOT replace specialist cardiology assessment
• Provides NICE-aligned probabilistic synthesis to support diagnosis and documentation
      </p>
    </div>
  </div>

  <!-- MODULE 1 -->
  <div class="card" id="module1">
    <h2>Module 1 — Clinical heart failure syndrome (required)</h2>
    <fieldset>
      <legend>Clinical assessment</legend>
      <label><input type="checkbox" id="hfSymptoms"> Symptoms and/or signs consistent with heart failure</label>
      <label><input type="checkbox" id="hfContributor"> Heart failure physiology is a likely/significant contributor to the presentation (even if co-contributors exist)</label>
    </fieldset>

    <div class="gate warn" id="m1Gate">
      Complete both items to proceed.
      <span class="muted">(NICE: heart failure is a clinical syndrome; tests provide supportive evidence.)</span>
    </div>
  </div>

  <!-- EF GATE -->
  <div class="card" id="efGateCard">
    <h2>EF gate — scope control</h2>
    <fieldset>
      <legend>Select ONE EF category</legend>
      <label><input type="radio" name="efcat" id="ef_ge50" value="ge50"> EF ≥50% (preserved EF)</label>
      <label><input type="radio" name="efcat" id="ef_41_49" value="41_49"> EF 41–49% (mildly reduced EF)</label>
      <label><input type="radio" name="efcat" id="ef_le40" value="le40"> EF ≤40% (reduced EF / HFrEF)</label>
    </fieldset>

    <div class="gate warn" id="efGate">Select one EF category to proceed.</div>

    <div class="outbox">
      <p class="output">
This tool applies only to suspected heart failure with preserved (≥50%) or mildly reduced (41–49%) ejection fraction.
If EF ≤40%, this pathway does not apply.
      </p>
    </div>
  </div>

  <!-- MODULE 2 -->
  <div class="card" id="module2">
    <h2>Module 2 — Echocardiographic interpretability</h2>

    <div class="grid two">
      <fieldset>
        <legend>Rhythm</legend>
        <label><input type="radio" name="rhythm" id="rhythm_sinus" value="sinus" checked> Sinus rhythm / not AF</label>
        <label><input type="radio" name="rhythm" id="rhythm_af" value="af"> Atrial fibrillation</label>
        <div class="hint">
          AF note: standard diastolic algorithms require modified criteria in AF; this framework treats AF as non-interpretable for HFpEF attribution and records Doppler values for documentation only.
        </div>
      </fieldset>

      <fieldset>
        <legend>Mitral regurgitation (explicit)</legend>
        <label><input type="radio" name="mr_severity" id="mr_none" value="none" checked> None / trivial</label>
        <label><input type="radio" name="mr_severity" id="mr_mild" value="mild"> Mild</label>
        <label><input type="radio" name="mr_severity" id="mr_mod" value="moderate"> Moderate</label>
        <label><input type="radio" name="mr_severity" id="mr_sev" value="severe"> Severe</label>
        <p class="muted"><strong>Significant MR</strong> = <strong>moderate or severe</strong>.</p>
      </fieldset>
    </div>

    <div class="grid two" style="margin-top:10px;">
      <fieldset>
        <legend>Aortic stenosis severity (gate-lite)</legend>
        <label><input type="radio" name="as_severity" id="as_none" value="none" checked> None / mild</label>
        <label><input type="radio" name="as_severity" id="as_mod" value="moderate"> Moderate</label>
        <label><input type="radio" name="as_severity" id="as_sev" value="severe"> Severe</label>
        <div class="hint">
          Moderate/severe AS: treated as dominant physiology here; Doppler indices are not used to attribute symptoms to HFpEF.
        </div>
      </fieldset>

      <fieldset>
        <legend>Image / Doppler quality</legend>
        <label><input type="radio" name="dopplerQuality" id="limitedEcho_no" value="no" checked> Adequate (no major limitation)</label>
        <label><input type="radio" name="dopplerQuality" id="limitedEcho_yes" value="yes"> Limited image or Doppler quality</label>
      </fieldset>
    </div>

    <div class="grid two" style="margin-top:10px;">
      <fieldset>
        <legend>Timing / fusion</legend>
        <label><input type="radio" name="timingFusion" id="pacing_no" value="no" checked> Not present / not stated</label>
        <label><input type="radio" name="timingFusion" id="pacing_yes" value="yes"> Pacing rhythm, tachycardia, or E–A fusion</label>
      </fieldset>

      <fieldset>
        <legend>Scope reminder</legend>
        <p class="output">This framework does not assign diastolic grade or filling pressure; it provides documentation-supportive synthesis using EF, structural context and natriuretic peptides.</p>
      </fieldset>
    </div>

    <div class="gate warn" id="m2Gate">
      Formal diastolic grading is not assigned when rhythm/valvular/technical limitations are present.
      The tool continues using EF + structural context + natriuretic peptides (NICE-aligned).
    </div>

    <div class="outbox">
      <h3>Interpretability statement (copy-ready)</h3>
      <p class="output" id="m2Text">
Formal diastolic grading is not assigned in this context. The tool continues using EF, structural echocardiographic context and natriuretic peptides (NICE-aligned).
      </p>
    </div>
  </div>

  <!-- MODULE 3 -->
  <div class="card" id="module3">
    <h2>Module 3 — Structural echocardiographic features (supportive)</h2>

    <div class="grid two">
      <fieldset>
        <legend>Left atrial size</legend>
        <label style="display:block; min-height:auto; user-select:auto;">
          Left atrial volume index (LAVI, ml/m²)
          <input type="number" id="lavi" inputmode="decimal" step="0.1" placeholder="e.g. 42">
        </label>
        <p class="muted">Reference: normal ≤34 ml/m².</p>
        <label><input type="checkbox" id="laQual"> LA enlargement reported qualitatively (no LAVI provided)</label>
        <p class="hint">LA area is intentionally not used in this framework (no invented cut-offs). RAE is not used.</p>
      </fieldset>

      <fieldset>
        <legend>LV wall thickness</legend>
        <label style="display:block; min-height:auto; user-select:auto;">
          Septal thickness (mm)
          <input type="number" id="ivs" inputmode="decimal" step="0.1" placeholder="e.g. 12">
        </label>
        <label style="display:block; min-height:auto; user-select:auto;">
          Posterior wall thickness (mm)
          <input type="number" id="pwd" inputmode="decimal" step="0.1" placeholder="e.g. 11">
        </label>
        <p class="muted">Reference: normal ≤10 mm; ≥11 mm supports LV wall thickening.</p>
      </fieldset>
    </div>

    <div class="grid two" style="margin-top:10px;">
      <fieldset>
        <legend>Pulmonary pressures (optional)</legend>
        <label style="display:block; min-height:auto; user-select:auto;">
          TR Vmax (m/s)
          <input type="number" id="trvmax" inputmode="decimal" step="0.01" placeholder="e.g. 3.1">
        </label>
        <p class="muted">Supportive threshold: TR Vmax &gt;2.8 m/s.</p>
        <label style="display:block; min-height:auto; user-select:auto;">
          PASP (mmHg)
          <input type="number" id="pasp" inputmode="decimal" step="1" placeholder="e.g. 42">
        </label>
        <p class="muted">Supportive threshold: PASP &gt;35 mmHg.</p>
      </fieldset>

      <fieldset>
        <legend>Optional Doppler context (supportive when interpretable)</legend>

        <div class="hint">
          Doppler values are recorded when available. They are <strong>never used to assign diastolic grade</strong>.
          If any non-interpretable condition is present (AF, significant MR, mod/sev AS, limited Doppler, pacing/fusion),
          Doppler values are displayed as documentation only and do not contribute to supportive logic.
        </div>

        <label style="display:block; min-height:auto; user-select:auto;">
          Septal e′ (cm/s)
          <input type="number" id="eprime_septal" inputmode="decimal" step="0.1" placeholder="e.g. 5.8">
        </label>
        <label style="display:block; min-height:auto; user-select:auto;">
          Lateral e′ (cm/s)
          <input type="number" id="eprime_lateral" inputmode="decimal" step="0.1" placeholder="e.g. 9.2">
        </label>

        <label style="display:block; min-height:auto; user-select:auto;">
          Average E/e′ (unitless)
          <input type="number" id="eeprime" inputmode="decimal" step="0.1" placeholder="e.g. 17.5">
        </label>

        <label style="display:block; min-height:auto; user-select:auto;">
          E/A ratio (unitless)
          <input type="number" id="ea_ratio" inputmode="decimal" step="0.01" placeholder="e.g. 0.8">
        </label>

        <label style="display:block; min-height:auto; user-select:auto;">
          Deceleration time (DT, ms)
          <input type="number" id="dt" inputmode="decimal" step="1" placeholder="e.g. 240">
        </label>

        <div class="hint">
          When interpretable, Doppler supportive context is treated cautiously: E/e′ &gt;14 and/or low e′ (septal &lt;7, lateral &lt;10)
          can strengthen supportive wording but cannot independently create “supportive HFpEF”, cannot override NP-low, and cannot override valve-dominant safeguards.
        </div>
      </fieldset>
    </div>

    <div class="grid two" style="margin-top:10px;">
      <fieldset>
        <legend>Safety principle</legend>
        <p class="output">Normal resting echocardiographic surrogates do not exclude exertional or load-dependent HFpEF.</p>
        <p class="muted">HFpEF may be exertional or load/heart-rate dependent; resting echo can be neutral.</p>
      </fieldset>

      <fieldset>
        <legend>Input safety</legend>
        <p class="muted">
          Non-physiological values (≤0) are ignored. Implausible values are flagged and ignored to reduce risk of documentation errors.
        </p>
      </fieldset>
    </div>

    <div class="outbox">
      <h3>Auto-generated echo interpretation snippets</h3>
      <div id="inputWarnings" style="display:none;"></div>
      <p class="output" id="echoSnips">Enter available echocardiographic values above to generate supportive statements.</p>
    </div>
  </div>

  <!-- MODULE 4 -->
  <div class="card" id="module4">
    <h2>Module 4 — Natriuretic peptides (NICE-prioritised)</h2>

    <div class="grid two">
      <fieldset>
        <legend>Measured values (numbers only)</legend>
        <label style="display:block; min-height:auto; user-select:auto;">
          BNP (pg/mL)
          <input type="number" id="bnp" inputmode="decimal" step="1" placeholder="e.g. 180">
        </label>
        <label style="display:block; min-height:auto; user-select:auto;">
          NT-proBNP (pg/mL)
          <input type="number" id="ntprobnp" inputmode="decimal" step="1" placeholder="e.g. 1600">
        </label>

        <!-- AF remains single source of truth from Module 2 -->
        <label><input type="checkbox" id="np_ckd"> CKD present (NP interpretation context)</label>

        <p class="muted">
          NICE thresholds used: NT-proBNP &lt;400 low; 400–2000 intermediate; ≥2000 high.
          BNP &lt;100 low; 100–400 intermediate; <strong>≥400 high</strong>.
        </p>
      </fieldset>

      <fieldset>
        <legend>Notes</legend>
        <p class="muted">
          AF context is taken from <strong>Module 2 rhythm selection</strong> and applied internally to NP interpretation text.
        </p>
        <p class="muted">
          If neither BNP nor NT-proBNP is available, NP tier is “unknown” and the tool will not output “supportive HFpEF” language or SGLT2 text.
        </p>
        <p class="muted">
          Safety: low NP reduces HF probability; echocardiographic indices should not override low NP within this framework.
        </p>
      </fieldset>
    </div>

    <div class="outbox">
      <h3>Auto-generated natriuretic peptide interpretation</h3>
      <p class="output" id="npSnip">Enter BNP and/or NT-proBNP to generate NP interpretation.</p>
    </div>
  </div>

  <!-- MODULE 5 -->
  <div class="card" id="module5">
    <h2>Module 5 — Output</h2>
    <p class="muted">
      This output is generated automatically from Modules 1–4. It supports documentation only and must be reviewed by the clinician.
      It does not constitute a diagnosis or a treatment directive.
    </p>

    <div class="outbox">
      <h3>Output text</h3>

      <!-- Copy-only block -->
      <div id="copyBlock" class="output">Complete Modules 1–4 to generate output.</div>

      <!-- Treatment shown separately (not copied) -->
      <div id="treatBlock" class="output" style="margin-top:10px;"></div>

      <textarea id="fallbackArea" class="srOnly" aria-hidden="true"></textarea>

      <div class="btnrow">
        <button id="copyBtn" disabled>Copy interpretive text</button>
        <button id="resetBtn" class="secondary" type="button">Reset</button>
        <span class="muted" id="toast" style="display:none; font-weight:900; color:var(--ok);">Copied ✓</span>
      </div>
    </div>
  </div>

  <!-- GOVERNANCE DISCLAIMER -->
  <details id="disclaimer">
    <summary>Disclaimer &amp; governance statement</summary>
    <div class="footer">
      <p><strong>Disclaimer:</strong> This tool is intended to support <strong>clinical reasoning and documentation</strong> in patients with suspected heart failure.</p>
      <p>It does <strong>not</strong> replace specialist cardiology input and does <strong>not</strong> mandate treatment.</p>
      <p>Clinical judgement, patient-specific factors, comorbidities, and local guidance must always be applied.</p>
    </div>
  </details>

  <!-- REFERENCES -->
  <details id="refs">
    <summary>References (compact)</summary>
    <div class="footer">
      <ol style="margin:10px 0 0 18px; padding:0;">
        <li>NICE. <i>Chronic heart failure in adults: diagnosis and management (NG106)</i>. 2018.</li>
        <li>Robinson S, Ring L, Oxborough D, et al. The assessment of left ventricular diastolic function: guidance and recommendations from the British Society of Echocardiography. <i>Echo Res Pract</i>. 2024;11:16. doi:10.1186/s44156-024-00051-2.</li>
        <li>McDonagh TA, et al. 2021 ESC Guidelines for the diagnosis and treatment of acute and chronic heart failure. <i>Eur Heart J</i>. 2021.</li>
        <li>Bozkurt B, et al. Universal definition and classification of heart failure. <i>J Card Fail</i>. 2021.</li>
        <li>Obokata M, et al. Role of diastolic stress testing in HFpEF. <i>Circulation</i>. 2017.</li>
        <li>Nagueh SF, et al. Evaluation of LV diastolic function by echocardiography. <i>J Am Soc Echocardiogr</i>. 2016.</li>
        <li>Anker SD, et al. EMPEROR-Preserved. <i>N Engl J Med</i>. 2021.</li>
        <li>Solomon SD, et al. DELIVER. <i>N Engl J Med</i>. 2022.</li>
        <li>Otto CM, et al. 2020 ACC/AHA Guideline for the Management of Patients With Valvular Heart Disease. <i>Circulation</i>. 2021.</li>
      </ol>
    </div>
  </details>

  <div class="footer" id="copyright">
    © 2026 <strong>Prabhath Fernando MBBS MD FRCP</strong>. <strong>All rights reserved.</strong><br>
    This tool and its underlying clinical logic may not be reproduced, modified, or redistributed without permission.
  </div>

</div><!-- /wrap -->

<script>
(function(){
  const el = (id)=>document.getElementById(id);
  const numRaw = (v)=> (v===null || v==='' || Number.isNaN(Number(v))) ? null : Number(v);

  function parsePlausible(id, opts){
    const v = numRaw(el(id).value);
    if (v === null) return { value:null, warn:null };

    const min = (opts && typeof opts.min === 'number') ? opts.min : null;
    const max = (opts && typeof opts.max === 'number') ? opts.max : null;

    if (min !== null && v <= min){
      return { value:null, warn:`${opts.label}: non-physiological value ignored.` };
    }
    if (max !== null && v > max){
      return { value:null, warn:`${opts.label}: value appears implausible and was ignored (check entry).` };
    }
    return { value:v, warn:null };
  }

  function isAF(){ return el('rhythm_af').checked; }

  function efCategory(){
    if (el('ef_ge50').checked) return 'ge50';
    if (el('ef_41_49').checked) return '41_49';
    if (el('ef_le40').checked) return 'le40';
    return '';
  }

  function mrSeverity(){
    if (el('mr_sev').checked) return 'severe';
    if (el('mr_mod').checked) return 'moderate';
    if (el('mr_mild').checked) return 'mild';
    if (el('mr_none').checked) return 'none';
    return '';
  }

  function asSeverity(){
    if (el('as_sev').checked) return 'severe';
    if (el('as_mod').checked) return 'moderate';
    return 'none';
  }

  function setCardEnabled(id, enabled){
    const c = el(id);
    c.style.opacity = enabled ? '1' : '.55';
    c.style.pointerEvents = enabled ? 'auto' : 'none';
  }

  function updateM1(){
    const ok = el('hfSymptoms').checked && el('hfContributor').checked;
    const gate = el('m1Gate');
    if (!ok){
      gate.className = 'gate warn';
      gate.innerHTML = 'Complete both items to proceed. <span class="muted">(NICE: HF is a clinical syndrome.)</span>';
      setCardEnabled('efGateCard', false);
      ['module2','module3','module4','module5'].forEach(id=>setCardEnabled(id,false));
      el('copyBlock').textContent = 'Complete Module 1 and EF gate to generate output.';
      el('treatBlock').textContent = '';
      el('copyBtn').disabled = true;
      return false;
    }
    gate.className = 'gate ok';
    gate.textContent = 'Gate passed. Proceed to EF scope control.';
    setCardEnabled('efGateCard', true);
    return true;
  }

  function updateEF(){
    const cat = efCategory();
    const gate = el('efGate');

    if (!cat){
      gate.className = 'gate warn';
      gate.textContent = 'Select one EF category to proceed.';
      ['module2','module3','module4','module5'].forEach(id=>setCardEnabled(id,false));
      el('copyBtn').disabled = true;
      el('copyBlock').textContent = 'Select an EF category to generate output.';
      el('treatBlock').textContent = '';
      return false;
    }

    if (cat === 'le40'){
      gate.className = 'gate stop';
      gate.innerHTML = '<strong>Stop:</strong> EF ≤40% is consistent with HFrEF. This tool applies only to preserved (≥50%) or mildly reduced (41–49%) EF.';
      ['module2','module3','module4','module5'].forEach(id=>setCardEnabled(id,false));
      el('copyBlock').textContent = 'EF ≤40% selected. This pathway does not apply (HFrEF).';
      el('treatBlock').textContent = '';
      el('copyBtn').disabled = true;
      return false;
    }

    gate.className = 'gate ok';
    gate.textContent = (cat==='ge50') ? 'EF gate passed: preserved EF.' : 'EF gate passed: mildly reduced EF.';
    ['module2','module3','module4','module5'].forEach(id=>setCardEnabled(id,true));
    return true;
  }

  function interpretability(){
    const limited = el('limitedEcho_yes').checked;
    const pacing = el('pacing_yes').checked;
    const mr = mrSeverity();
    const as = asSeverity();
    const significantMR = (mr==='moderate' || mr==='severe');
    const significantAS = (as==='moderate' || as==='severe');

    const reasons=[];
    if (isAF()) reasons.push('atrial fibrillation');
    if (significantMR) reasons.push('significant mitral regurgitation');
    if (significantAS) reasons.push('moderate/severe aortic stenosis (dominant valve physiology)');
    if (limited) reasons.push('limited image/Doppler quality');
    if (pacing) reasons.push('pacing/tachycardia/E–A fusion');

    const dopplerInterpretable = reasons.length === 0;

    return { limited, pacing, significantMR, significantAS, reasons, dopplerInterpretable };
  }

  function updateM2(){
    const it = interpretability();
    const gate = el('m2Gate');
    const text = el('m2Text');

    if (it.reasons.length){
      gate.className = 'gate warn';
      gate.innerHTML =
        '<strong>Interpretability:</strong> Formal diastolic grading is not assigned due to ' + it.reasons.join(', ') + '. ' +
        'The tool continues using EF + structural context + natriuretic peptides (NICE-aligned).';
      text.textContent =
        'Formal diastolic grading is not assigned in this context. The tool continues using EF, structural echocardiographic context and natriuretic peptides (NICE-aligned).';
    } else {
      gate.className = 'gate ok';
      gate.textContent =
        'No major rhythm/valvular/technical limitation selected. (This framework still does not assign a diastolic grade; it provides supportive synthesis.)';
      text.textContent =
        'Formal diastolic grading is not assigned within this framework; echocardiographic parameters are interpreted as supportive context alongside natriuretic peptides and clinical findings.';
    }
  }

  function npTier(){
    const nt = numRaw(el('ntprobnp').value);
    if (nt !== null){
      if (nt < 400) return 'low';
      if (nt >= 2000) return 'high';
      return 'mid';
    }
    const bnp = numRaw(el('bnp').value);
    if (bnp !== null){
      if (bnp < 100) return 'low';
      if (bnp >= 400) return 'high'; // >=400 alignment
      return 'mid';
    }
    return '';
  }

  function updateNPSnip(){
    const tier = npTier();

    const ctx=[];
    if (isAF()) ctx.push('AF');
    if (el('np_ckd').checked) ctx.push('CKD');
    const ctxStr = ctx.length ? ` Context: ${ctx.join(', ')}.` : '';

    const bnp = numRaw(el('bnp').value);
    const nt = numRaw(el('ntprobnp').value);
    let vals='';
    if (bnp !== null) vals += `BNP ${Math.round(bnp)} pg/mL. `;
    if (nt !== null) vals += `NT-proBNP ${Math.round(nt)} pg/mL. `;

    if (!tier){
      el('npSnip').textContent = 'Enter BNP and/or NT-proBNP to generate NP interpretation.';
      return;
    }

    if (tier === 'low'){
      el('npSnip').textContent = `${vals}Natriuretic peptide interpretation: low (HF less likely; NICE thresholds).${ctxStr}`;
    } else if (tier === 'mid'){
      el('npSnip').textContent = `${vals}Natriuretic peptide interpretation: intermediate/indeterminate (NICE thresholds).${ctxStr}`;
    } else {
      el('npSnip').textContent = `${vals}Natriuretic peptide interpretation: high/elevated (NICE thresholds).${ctxStr} Natriuretic peptides provide objective evidence of myocardial stress when interpreted with imaging and clinical context.`;
    }
  }

  function calloutHTML(level, title, body){
    return `
      <div class="callout ${level}">
        <div class="title">${title}</div>
        <div>${body}</div>
      </div>
    `;
  }

  function updateEchoSnips(){
    const it = interpretability();

    const warnings = [];

    // Structural values with plausibility guards
    const laviObj = parsePlausible('lavi', { min:0, max:200, label:'LAVI' });
    if (laviObj.warn) warnings.push(laviObj.warn);
    const lavi = laviObj.value;

    const ivsObj = parsePlausible('ivs', { min:0, max:30, label:'Septal thickness' });
    if (ivsObj.warn) warnings.push(ivsObj.warn);
    const ivs = ivsObj.value;

    const pwdObj = parsePlausible('pwd', { min:0, max:30, label:'Posterior wall thickness' });
    if (pwdObj.warn) warnings.push(pwdObj.warn);
    const pwd = pwdObj.value;

    const trObj = parsePlausible('trvmax', { min:0, max:6, label:'TR Vmax' });
    if (trObj.warn) warnings.push(trObj.warn);
    const tr = trObj.value;

    const paspObj = parsePlausible('pasp', { min:0, max:120, label:'PASP' });
    if (paspObj.warn) warnings.push(paspObj.warn);
    const pasp = paspObj.value;

    // Doppler optional fields with plausibility guards
    const epsObj = parsePlausible('eprime_septal', { min:0, max:30, label:'Septal e′' });
    if (epsObj.warn) warnings.push(epsObj.warn);
    const eSept = epsObj.value;

    const eplObj = parsePlausible('eprime_lateral', { min:0, max:30, label:'Lateral e′' });
    if (eplObj.warn) warnings.push(eplObj.warn);
    const eLat = eplObj.value;

    const eeObj = parsePlausible('eeprime', { min:0, max:60, label:'E/e′' });
    if (eeObj.warn) warnings.push(eeObj.warn);
    const ee = eeObj.value;

    const eaObj = parsePlausible('ea_ratio', { min:0, max:5, label:'E/A ratio' });
    if (eaObj.warn) warnings.push(eaObj.warn);
    const ea = eaObj.value;

    const dtObj = parsePlausible('dt', { min:0, max:600, label:'Deceleration time' });
    if (dtObj.warn) warnings.push(dtObj.warn);
    const dt = dtObj.value;

    // warnings UI
    const wEl = el('inputWarnings');
    if (warnings.length){
      wEl.style.display = 'block';
      wEl.className = 'warnList';
      wEl.textContent = 'Input check: ' + warnings.join(' ');
    } else {
      wEl.style.display = 'none';
      wEl.className = '';
      wEl.textContent = '';
    }

    const snips=[];
    const mr = mrSeverity();
    const as = asSeverity();
    const significantMR = (mr==='moderate' || mr==='severe');
    const significantAS = (as==='moderate' || as==='severe');

    const valveNote =
      (significantMR && significantAS) ? ' (interpret cautiously in significant MR and moderate/severe AS).' :
      significantMR ? ' (non-specific in significant MR).' :
      significantAS ? ' (may reflect pressure overload in moderate/severe AS).' :
      '.';

    const laQual = el('laQual').checked;

    if (lavi !== null){
      if (lavi > 34){
        snips.push(`Left atrial volume index is ${lavi.toFixed(1)} ml/m² (normal ≤34). Left atrial enlargement supports chronic atrial/diastolic burden${valveNote}`);
      } else {
        snips.push(`Left atrial volume index is ${lavi.toFixed(1)} ml/m² (normal ≤34). Normal LA size does not exclude HFpEF.`);
      }
    } else if (laQual){
      snips.push(`Left atrial enlargement reported qualitatively (LAVI not provided). Left atrial enlargement supports chronic atrial/diastolic burden${valveNote}`);
    }

    if (ivs !== null || pwd !== null){
      const thick = (ivs !== null && ivs >= 11) || (pwd !== null && pwd >= 11);
      const parts=[];
      if (ivs !== null) parts.push(`septal ${ivs.toFixed(1)} mm`);
      if (pwd !== null) parts.push(`posterior ${pwd.toFixed(1)} mm`);
      if (thick){
        snips.push(`LV wall thickness (${parts.join(', ')}) indicates LV wall thickening, supporting a pressure-loading phenotype consistent with HFpEF.`);
      } else {
        snips.push(`LV wall thickness (${parts.join(', ')}) is within normal limits; absence of LVH does not exclude HFpEF.`);
      }
    }

    // Show TR and/or PASP snippets if entered (not mutually exclusive)
    if (tr !== null){
      if (tr > 2.8){
        snips.push(`TR Vmax ${tr.toFixed(2)} m/s (>2.8) supports elevated pulmonary pressures in context${valveNote}`);
      } else {
        snips.push(`TR Vmax ${tr.toFixed(2)} m/s (≤2.8). Normal TR velocity does not exclude HFpEF.`);
      }
    }
    if (pasp !== null){
      if (pasp > 35){
        snips.push(`Estimated PASP ${Math.round(pasp)} mmHg (>35) supports elevated pulmonary pressures in context${valveNote}`);
      } else {
        snips.push(`Estimated PASP ${Math.round(pasp)} mmHg (≤35). Normal PASP does not exclude HFpEF.`);
      }
    }

    // Doppler documentation snippets
    const anyDoppler = (eSept !== null || eLat !== null || ee !== null || ea !== null || dt !== null);
    if (anyDoppler){
      const parts=[];
      if (eSept !== null) parts.push(`septal e′ ${eSept.toFixed(1)} cm/s`);
      if (eLat !== null) parts.push(`lateral e′ ${eLat.toFixed(1)} cm/s`);
      if (ee !== null) parts.push(`E/e′ ${ee.toFixed(1)}`);
      if (ea !== null) parts.push(`E/A ${ea.toFixed(2)}`);
      if (dt !== null) parts.push(`DT ${Math.round(dt)} ms`);

      if (!it.dopplerInterpretable){
        snips.push(`Doppler indices recorded for completeness (${parts.join(', ')}). Not used to support HFpEF attribution here because of ${it.reasons.join(', ')}.`);
      } else {
        snips.push(`Doppler indices (${parts.join(', ')}) provide supportive evidence consistent with raised filling pressures/diastolic dysfunction in context. No diastolic grade is assigned and Doppler findings do not independently establish HFpEF.`);
      }
    }

    el('echoSnips').textContent = snips.length ? snips.join('\n\n')
      : 'Enter available echocardiographic values above to generate supportive statements.';
  }

  function computeSupportFlags(){
    // Structural values
    const lavi = parsePlausible('lavi', { min:0, max:200, label:'LAVI' }).value;
    const laQual = el('laQual').checked;
    const laSupport = ((lavi !== null) && lavi > 34) || laQual;

    const ivs = parsePlausible('ivs', { min:0, max:30, label:'Septal thickness' }).value;
    const pwd = parsePlausible('pwd', { min:0, max:30, label:'Posterior wall thickness' }).value;
    const lvhSupport = ((ivs !== null) && ivs >= 11) || ((pwd !== null) && pwd >= 11);

    const tr = parsePlausible('trvmax', { min:0, max:6, label:'TR Vmax' }).value;
    const pasp = parsePlausible('pasp', { min:0, max:120, label:'PASP' }).value;
    const pulmSupport = ((tr !== null) && tr > 2.8) || ((pasp !== null) && pasp > 35);

    const structuralSupport = laSupport || lvhSupport || pulmSupport;

    // Doppler values
    const it = interpretability();
    const eSept = parsePlausible('eprime_septal', { min:0, max:30, label:'Septal e′' }).value;
    const eLat  = parsePlausible('eprime_lateral', { min:0, max:30, label:'Lateral e′' }).value;
    const ee    = parsePlausible('eeprime', { min:0, max:60, label:'E/e′' }).value;

    // Conservative Doppler support definition:
    // - Only if interpretable
    // - Only if E/e′ >14 OR e′ clearly low (septal<7 OR lateral<10)
    // - DOES NOT create supportive output by itself; only modulates wording
    let dopplerSupport = false;
    if (it.dopplerInterpretable){
      if (ee !== null && ee > 14) dopplerSupport = true;
      if (eSept !== null && eSept < 7) dopplerSupport = true;
      if (eLat !== null && eLat < 10) dopplerSupport = true;
    }

    return { structuralSupport, dopplerSupport, dopplerInterpretable: it.dopplerInterpretable };
  }

  function buildFinal(){
    if (!(updateM1() && updateEF())) return;

    updateM2();
    updateEchoSnips();
    updateNPSnip();

    const it = interpretability();

    const mr = mrSeverity();
    const as = asSeverity();
    const significantMR = (mr==='moderate' || mr==='severe');
    const significantAS = (as==='moderate' || as==='severe');

    const limitations = it.reasons.slice();

    const echoText = el('echoSnips').textContent.startsWith('Enter') ? '' : el('echoSnips').textContent;
    const npText = el('npSnip').textContent.startsWith('Enter') ? '' : el('npSnip').textContent;

    const tier = npTier();
    const npLowFlag = (tier === 'low');
    const npHighFlag = (tier === 'high');
    const npKnown = (tier !== '');

    const flags = computeSupportFlags();
    const structuralSupport = flags.structuralSupport;
    const dopplerSupport = flags.dopplerSupport;

    // Outcome state (categories unchanged)
    let hfpEfStatus = 'indeterminate';
    if (!npKnown) hfpEfStatus = 'indeterminate';
    else if (npLowFlag) hfpEfStatus = 'not_supportive';
    else if (structuralSupport) hfpEfStatus = 'supportive';
    else hfpEfStatus = 'indeterminate';

    // Valve dominant safeguards override (AS dominant)
    if (significantAS) hfpEfStatus = 'indeterminate';

    const interpretive = [];
    const treatment = [];

    interpretive.push(`<div class="sectionHead">INTERPRETIVE DOCUMENTATION</div>`);

    // Valve dominant pathways
    if (significantMR){
      interpretive.push(`<div>${[
        'The patient has clinical features consistent with a heart failure syndrome with preserved or mildly reduced ejection fraction.',
        'Formal diastolic grading is not assigned due to significant mitral regurgitation.',
        'In this context, left atrial enlargement, pulmonary pressure surrogates, and raised natriuretic peptides may reflect valvular volume overload and atrial stretch rather than primary myocardial diastolic dysfunction.'
      ].join(' ')}</div>`);

      if (echoText) interpretive.push(`<div><b>Echocardiographic context:</b> ${echoText.replace(/\n+/g,' ').trim()}</div>`);
      if (npText) interpretive.push(`<div><b>Natriuretic peptide context:</b> ${npText.replace(/\n+/g,' ').trim()}</div>`);

      interpretive.push(calloutHTML(
        'stop',
        'KEY INTERPRETATION (MR-dominant physiology)',
        'Therefore, echocardiography and natriuretic peptides in this setting cannot be used to support or refute a HFpEF phenotype, and attribution to HFpEF remains indeterminate.'
      ));

      interpretive.push(`<div>Management decisions should prioritise assessment of the haemodynamic significance of mitral regurgitation, recognising that co-existing HFpEF cannot be excluded but cannot be reliably inferred from resting diastolic surrogates in significant MR.</div>`);

      treatment.push(`<div class="sectionHead">TREATMENT GUIDANCE (CONTEXT-DEPENDENT, NON-DIRECTIVE)</div>`);
      treatment.push(`<ul>
        <li>In significant mitral regurgitation, HFpEF-specific therapy should not be inferred from resting diastolic surrogates alone; management should be guided by dominant valvular physiology and the overall clinical syndrome.</li>
        <li>If congested, symptomatic treatment (including diuretics) should be guided by clinical volume status and response, with monitoring of renal function and electrolytes.</li>
      </ul>`);

    } else if (significantAS){
      interpretive.push(`<div>${[
        'The patient has clinical features consistent with a heart failure syndrome with preserved or mildly reduced ejection fraction.',
        'Moderate/severe aortic stenosis is present and is treated here as dominant valve physiology.',
        'In this context, natriuretic peptide elevation, left atrial enlargement and pulmonary pressure surrogates may reflect pressure overload from aortic stenosis rather than primary myocardial diastolic dysfunction.'
      ].join(' ')}</div>`);

      if (echoText) interpretive.push(`<div><b>Echocardiographic context:</b> ${echoText.replace(/\n+/g,' ').trim()}</div>`);
      if (npText) interpretive.push(`<div><b>Natriuretic peptide context:</b> ${npText.replace(/\n+/g,' ').trim()}</div>`);

      interpretive.push(calloutHTML(
        'stop',
        'KEY INTERPRETATION (AS-dominant physiology)',
        'Therefore, echocardiography and natriuretic peptides in this setting cannot be used to support or refute a primary HFpEF phenotype, and attribution to HFpEF remains indeterminate.'
      ));

      interpretive.push(`<div>Management decisions should prioritise assessment of the haemodynamic significance of aortic stenosis, recognising that co-existing HFpEF cannot be excluded but should not be inferred automatically from resting surrogates in dominant valve disease.</div>`);

      treatment.push(`<div class="sectionHead">TREATMENT GUIDANCE (CONTEXT-DEPENDENT, NON-DIRECTIVE)</div>`);
      treatment.push(`<ul>
        <li>In moderate/severe aortic stenosis, HFpEF-directed therapy should not be inferred automatically from resting diastolic surrogates; management should be guided by dominant valve physiology and the overall clinical syndrome.</li>
        <li>If congested, symptomatic treatment (including diuretics) should be guided by clinical volume status and response, with monitoring of renal function and electrolytes.</li>
      </ul>`);

    } else {
      // General pathway
      const para = [];
      para.push('The patient has clinical features consistent with a heart failure syndrome with preserved or mildly reduced ejection fraction.');

      if (limitations.length){
        para.push('Formal diastolic grading is not assigned due to ' + limitations.join(', ') + '.');
      } else {
        para.push('Formal diastolic grading is not assigned within this framework; echocardiographic parameters are interpreted as supportive context.');
      }

      if (echoText){
        para.push('Echocardiography demonstrates structural findings as follows: ' + echoText.replace(/\n+/g,' ').trim());
      } else {
        para.push('Echocardiography is used to exclude alternative dominant pathology and provide supportive structural context; normal resting findings do not exclude exertional or load/heart-rate dependent HFpEF.');
      }

      if (npText){
        para.push(npText.replace(/\n+/g,' ').trim());
      } else {
        para.push('Natriuretic peptides should be interpreted alongside symptoms and echocardiographic findings.');
      }

      interpretive.push(`<div>${para.join(' ')}</div>`);

      // Outcome callouts (categories unchanged; wording modulated by Doppler support)
      if (!npKnown){
        interpretive.push(calloutHTML(
          'warn',
          'KEY INTERPRETATION (NP unavailable)',
          'Natriuretic peptide values are not available in this record; HFpEF probability remains indeterminate and should be reassessed when biomarkers are available. This framework will not output “supportive HFpEF” language or SGLT2 therapy text without measured NP values.'
        ));
      } else if (hfpEfStatus === 'not_supportive'){
        interpretive.push(calloutHTML(
          'warn',
          'KEY INTERPRETATION (Low NP cap)',
          'Natriuretic peptide levels are low, which reduces the probability of heart failure in this clinical context. Within this framework, echocardiographic surrogates should not override a low natriuretic peptide tier; alternative explanations should be considered, with clinical reassessment if the presentation evolves.'
        ));
      } else if (hfpEfStatus === 'indeterminate'){
        interpretive.push(calloutHTML(
          'warn',
          'KEY INTERPRETATION (Indeterminate HFpEF attribution)',
          'Echocardiography is structurally neutral and does not provide supportive structural evidence of HFpEF. In the setting of natriuretic peptide values that are not low, discordance between biomarkers and resting structural findings means HFpEF probability remains indeterminate; consider alternative explanations and reassess if the presentation evolves.'
        ));
      } else {
        if (dopplerSupport){
          interpretive.push(calloutHTML(
            'ok',
            'KEY INTERPRETATION (Supportive HFpEF phenotype — more supportive context)',
            'Taken together, the overall picture is more supportive of a HFpEF phenotype in this clinical context. This remains probabilistic and should be interpreted alongside symptoms, comorbidity burden and response to treatment, with planned reassessment.'
          ));
        } else {
          interpretive.push(calloutHTML(
            'ok',
            'KEY INTERPRETATION (Supportive HFpEF phenotype)',
            'Taken together, the overall picture may be supportive of a HFpEF phenotype in this clinical context. This remains probabilistic and should be interpreted alongside symptoms, comorbidity burden and response to treatment, with planned reassessment.'
          ));
        }
      }

      // Treatment block (unchanged posture)
      treatment.push(`<div class="sectionHead">TREATMENT GUIDANCE (CONTEXT-DEPENDENT, NON-DIRECTIVE)</div>`);

      const efCat = efCategory();
      if ((efCat === 'ge50' || efCat === '41_49') && npKnown && npHighFlag && structuralSupport && !significantAS){
        treatment.push(`<ul><li>Consideration of SGLT2 inhibitor therapy is supported by evidence in heart failure populations with preserved or mildly reduced ejection fraction, independent of formal diastolic grading; initiate with appropriate renal function review and monitoring.</li></ul>`);
      }

      const other = [];
      if (isAF()){
        other.push('Atrial fibrillation is a recognised HFpEF-associated phenotype; optimisation of AF management (rate/rhythm strategy as clinically appropriate) and comorbidity control forms part of holistic care.');
      }
      other.push('Diuretic therapy, where required, should be guided by clinical congestion and response rather than diastolic indices alone, with monitoring of renal function and electrolytes.');
      treatment.push(`<ul>${other.map(x=>`<li>${x}</li>`).join('')}</ul>`);
    }

    el('copyBlock').innerHTML = interpretive.join('\n');
    el('treatBlock').innerHTML = treatment.join('\n');
    el('copyBtn').disabled = false;
  }

  async function copyTextToClipboard(text){
    try{
      await navigator.clipboard.writeText(text);
      return true;
    }catch(e){}

    try{
      const ta = el('fallbackArea');
      ta.className = '';
      ta.value = text;
      ta.style.position='fixed';
      ta.style.left='-9999px';
      ta.style.top='0';
      ta.setAttribute('readonly','');
      document.body.appendChild(ta);
      ta.focus();
      ta.select();
      const ok = document.execCommand('copy');
      ta.blur();
      ta.className='srOnly';
      return !!ok;
    }catch(e){
      return false;
    }
  }

  el('copyBtn').addEventListener('click', async ()=>{
    const textToCopy = el('copyBlock').innerText;
    const ok = await copyTextToClipboard(textToCopy);
    if (ok){
      el('toast').style.display='inline';
      setTimeout(()=>el('toast').style.display='none',1200);
    } else {
      alert('Copy not available. Please select and copy manually.');
    }
  });

  el('resetBtn').addEventListener('click', ()=>{
    document.querySelectorAll('input').forEach(i=>{
      if (i.type==='checkbox') i.checked=false;
      if (i.type==='radio') i.checked=false;
      if (i.type==='number') i.value='';
    });

    // defaults
    el('mr_none').checked = true;
    el('as_none').checked = true;
    el('rhythm_sinus').checked = true;
    el('limitedEcho_no').checked = true;
    el('pacing_no').checked = true;
    el('np_ckd').checked = false;

    el('inputWarnings').style.display='none';
    el('inputWarnings').className='';
    el('inputWarnings').textContent='';

    el('echoSnips').textContent = 'Enter available echocardiographic values above to generate supportive statements.';
    el('npSnip').textContent = 'Enter BNP and/or NT-proBNP to generate NP interpretation.';
    el('copyBlock').textContent = 'Complete Modules 1–4 to generate output.';
    el('treatBlock').textContent = '';
    el('copyBtn').disabled = true;

    updateM1();
    window.scrollTo({top:0,behavior:'smooth'});
  });

  document.querySelectorAll('input').forEach(i=>{
    i.addEventListener('change', buildFinal);
    i.addEventListener('input', buildFinal);
  });

  // defaults
  el('mr_none').checked = true;
  el('as_none').checked = true;
  el('rhythm_sinus').checked = true;
  el('limitedEcho_no').checked = true;
  el('pacing_no').checked = true;

  updateM1();
})();
</script>

</body>
</html>
